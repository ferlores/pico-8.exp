pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
-- pang
-- by ferlores

__init, __update, __draw = {}, {}, {}
function register(cb, f)
    if (cb == 'init') add(__init, f)
    if (cb == 'update') add(__update, f)
    if (cb == 'draw') add(__draw, f)
end

function _init()
    for f in all(__init) do
        f()
    end
end

function _update()
    for f in all(__update) do
        f()
    end
end

function _draw()
    cls()
    for f in all(__draw) do
        f()
    end
end

-->8
-- player
player_speed = 0.5
player_friction = 0.3
player_width = 8
player_height = 8
players = {}

-- add_players
register('init', function ()
    add(players, {
        spr = 1,
        x = screen_max/2 - player_width,
        y = screen_max - player_height,
        dx = 0,
        dy = 0,
        speed = player_speed,
        friction = player_friction,
        weapon = 1
    })
end)

-- move_players
register('update', function ()
    control_player(players[1], 0)

    for p in all(players) do
        p.x = mid(screen_min, p.x + p.dx, screen_max - player_width)
        p.y += p.dy

        p.dx *= (1 - p.friction)
        p.dy *= (1 - p.friction)

        add_hud('p:'..p.x..', '..p.y..', '..p.dx..', '..p.dy)
    end
end)

function control_player(p, control)
    if (btn(⬅️, control)) p.dx -= p.speed
    if (btn(➡️, control)) p.dx += p.speed
    if (btnp(❎, control)) add_bullet(p)
end

-- draw_players
register('draw', function ()
    for p in all(players) do
        spr(p.spr, p.x, p.y)
    end
end)

-->8
-- bullets
max_bullets = 2
bullets = {}
weapons = {
    [1] =  {
        spr = 16,
        sfx = 0,
        dx = 0,
        dy = 3,
        w = 8,
        h = 8
    }
}

function add_bullet(p)
    if (#bullets >= max_bullets) return

    local w = weapons[p.weapon]
    add(bullets, {
        x = p.x,
        y = p.y - player_height,
        dx = w.dx,
        dy = w.dy,
        tp = p.weapon
    })
    sfx(w.sfx)
end

-- move_bullets
register('update', function ()
    for i=1,#bullets do
        local b = bullets[i]
        -- ensures is not nil after we remove a bullet
        if (b != nil) then
            b.x = b.x + b.dx
            b.y = b.y - b.dy

            -- remove bullet
            if (is_offscreen(b.x, b.y, weapons[b.tp].w, weapons[b.tp].h)) bullets[i] = nill
        end
    end
end)

-- draw_bullets
register('draw', function ()
    for b in all(bullets) do
        local w = weapons[b.tp]
        spr(w.spr, b.x, b.y)
        spr(w.spr + 16, b.x, b.y + w.h)
        add_hud('w:'..b.x..', '..b.y..', '..b.dx..', '..b.dy)
    end
end)

-->8
-- balls

balls = {}
ball_tp = {
    [1] =  {
        sfx = 0,
        dx = 0,
        dy = 3,
        w = 8,
        h = 8
    }
}

ball_render = {
    [2] = function (x, y) spr(66, x, y) end,
    [4] = function (x, y) spr(65, x, y) end,
    [8] = function (x, y) spr(64, x, y) end,
    [8] = function (x, y) sspr(0, 32, 8, 8, x, y, 12, 12) end,
    [16] = function (x, y) sspr(0, 32, 8, 8, x, y, 16, 16) end,
    [24] = function (x, y) sspr(0, 32, 8, 8, x, y, 24, 24) end,
    [32] = function (x, y) sspr(0, 32, 8, 8, x, y, 32, 32) end
}

-- add_ball
register('init', function ()
    local bt = ball_tp[1]
    add(balls, {
        tp = 1,
        x = screen_max/2 - 16,
        y = screen_max/2 - 16,
        dx = bt.dx,
        dy = bt.dy,
        sz = 32
    })
    logTable("balls", balls)
end)


function move_ball()
end

-- draw_ball
register("draw", function ()
    for b in all(balls) do
        ball_render[b.sz](b.x, b.y)
        add_hud('b:'..b.x..', '..b.y..', '..b.dx..', '..b.dy)
    end
end)



-->8
-- scene

screen_min = 1
screen_max = 127

-- draw_scene
register('draw', function ()
    rect(0,0,127,127,15)
    draw_hud()
end)

function is_offscreen(x, y, w, h)
    return
        x < screen_min or
        x + w > screen_max or
        y < screen_min or
        y + h > screen_max
end


#include utilities.lua

__gfx__
00000000000000007700007700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000055555507078880700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000005dd5007088880702222e00005557000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000055dd550088008800022e000000570000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000005dddd50000760000022e000000570000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000005ddd65070600607002e2000000550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000445d65447066660704222400004554000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000495555497700007704020400004004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00044400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00406040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000006555556600000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000006555556600000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000005566655500000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000005566655500000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000006555d56600000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000655dd56600000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000005566655500000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000005566655500000000000000000000000000000000000000000000000000000000
009999000a900000a900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
099a9990a99900009900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99a99999999900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999099000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
99999949000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
09994490000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00999900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100000a750097500a7500b7500c7500e75011750157501a7501f74023730247202e70009000080000800008000080000000000000000000000000000000000000000000000000000000000000000000000000
